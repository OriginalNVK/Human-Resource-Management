--ALTER SESSION SET CONTAINER = CDB$ROOT;
--ALTER PLUGGABLE DATABASE PDBQLDH CLOSE IMMEDIATE;
DROP PLUGGABLE DATABASE PDBQLDH INCLUDING DATAFILES;
CREATE PLUGGABLE DATABASE PDBQLDH
ADMIN USER pdb_admin IDENTIFIED BY 123
ROLES = (DBA)
FILE_NAME_CONVERT = ('D:\Setup\Oracle\oradata\',
                     'D:\Setup\Oracle\oradata\PDBQLDH');

GRANT SYSDBA TO pdb_admin;
ALTER PLUGGABLE DATABASE PDBQLDH OPEN READ WRITE; 
ALTER SESSION SET CONTAINER= PDBQLDH;   
ALTER SESSION SET CURRENT_SCHEMA = pdb_admin;
GRANT DBA TO pdb_admin

CREATE TABLE QLDH_ADMIN(
    MAAD VARCHAR2(10) PRIMARY KEY,
    HOTEN VARCHAR2(50) NOT NULL,
    PHAI VARCHAR2(3) CHECK (PHAI IN ('Nam', 'Nu')),
    NGSINH DATE,
    DCHI VARCHAR2(100),
    DT VARCHAR2(15)
);

INSERT INTO QLDH_ADMIN (MAAD, HOTEN, PHAI, NGSINH, DCHI, DT)
VALUES ('PDB_ADMIN', 'Nguyen Van Admin', 'Nam', TO_DATE('01-01-1980', 'DD-MM-YYYY'), 'Hà Nội', '0987654321');

--Tạo bảng ĐONVI
CREATE TABLE QLDH_DONVI (
    MADV VARCHAR2(10) PRIMARY KEY,
    TENDV VARCHAR2(50) NOT NULL,
    LOAIDV VARCHAR2(10) CHECK (LOAIDV IN ('Khoa', 'Phong')),
    TRGDV VARCHAR2(10)
);

--Tạo bảng NHANVIEN
CREATE TABLE QLDH_NHANVIEN (
    MANV VARCHAR2(10) PRIMARY KEY,
    HOTEN VARCHAR2(50) NOT NULL,
    PHAI VARCHAR2(3) CHECK (PHAI IN ('Nam', 'Nu')),
    NGSINH DATE,
    DCHI VARCHAR2(100),
    LUONG NUMBER(15,2),
    PHUCAP NUMBER(15,2),
    DT VARCHAR2(15),
    VAITRO VARCHAR2(30) CHECK (VAITRO IN ('NVCB', 'GV', 'NV PĐT', 'NV PKT', 'NV TCHC', 'NV CTSV', 'TRGĐV')),
    MADV VARCHAR2(10),
    CONSTRAINT FK_NV_MADV FOREIGN KEY (MADV) REFERENCES QLDH_DONVI(MADV)
);

--Thêm khóa ngoại TRGDV vào bảng DONVI
ALTER TABLE QLDH_DONVI
ADD CONSTRAINT FK_TRGDV FOREIGN KEY (TRGDV) REFERENCES QLDH_NHANVIEN(MANV);
--Tạo bảng SINHVIEN
CREATE TABLE QLDH_SINHVIEN (
    MASV VARCHAR2(10) PRIMARY KEY,
    HOTEN VARCHAR2(50) NOT NULL,
    PHAI VARCHAR2(3) CHECK (PHAI IN ('Nam', 'Nu')),
    NGSINH DATE,
    DCHI VARCHAR2(100),
    DT VARCHAR2(15),
    KHOA VARCHAR2(10),
    TINHTRANG VARCHAR2(20) CHECK (TINHTRANG IN ('Dang hoc', 'Nghi hoc', 'Bao luu')),
    CONSTRAINT FK_SV_KHOA FOREIGN KEY (KHOA) REFERENCES QLDH_DONVI(MADV)
);
--Tạo bảng HOCPHAN
CREATE TABLE QLDH_HOCPHAN (
    MAHP VARCHAR2(10) PRIMARY KEY,
    TENHP VARCHAR2(50) NOT NULL,
    SOTC NUMBER(2),
    STLT NUMBER(3),
    STTH NUMBER(3),
    MADV VARCHAR2(10),
    FOREIGN KEY (MADV) REFERENCES QLDH_DONVI(MADV)
);
--Tạo bảng MOMON
CREATE TABLE QLDH_MONHOC (
    MAMH VARCHAR2(10) PRIMARY KEY,
    MAHP VARCHAR2(10),
    MAGV VARCHAR2(10),
    HK NUMBER(1) CHECK (HK IN (1, 2, 3)),
    NAM NUMBER(4),
    NGAYBATDAU DATE,
    NGAYKETTHUC DATE,
    FOREIGN KEY (MAHP) REFERENCES QLDH_HOCPHAN(MAHP),
    FOREIGN KEY (MAGV) REFERENCES QLDH_NHANVIEN(MANV)
);
--Tạo bảng DANGKY
CREATE TABLE QLDH_DANGKY (
    MASV VARCHAR2(10),
    MAMH VARCHAR2(10),
    DIEMTH NUMBER(4,2),
    DIEMQT NUMBER(4,2),
    DIEMCK NUMBER(4,2),
    DIEMTK NUMBER(4,2),
    NGAYDK DATE,
    PRIMARY KEY (MASV, MAMH),
    FOREIGN KEY (MASV) REFERENCES QLDH_SINHVIEN(MASV),
    FOREIGN KEY (MAMH) REFERENCES QLDH_MONHOC(MAMH)
);

----------------------------------------------------------------------------------------
-- Thêm giá trị cho DonVi
INSERT INTO pdb_admin.QLDH_DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('KH01', 'Khoa Công nghệ thông tin', 'Khoa', NULL);
INSERT INTO pdb_admin.QLDH_DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('KH02', 'Khoa Kinh tế', 'Khoa',NULL);
INSERT INTO pdb_admin.QLDH_DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('KH03', 'Khoa Ngoại ngữ', 'Khoa', NULL);
INSERT INTO pdb_admin.QLDH_DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('PH01', 'Phòng Khảo Thí', 'Phong', NULL);
INSERT INTO pdb_admin.QLDH_DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('PH02', 'Phòng Đào tạo', 'Phong', NULL);


-- Thêm dữ liệu mẫu cho MOMON
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH01', 'HP01', 'GV01', '1', '2024', TO_DATE('01-09-2024', 'DD-MM-YYYY'), TO_DATE('30-12-2024', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH02', 'HP02', 'GV01', '1', '2024', TO_DATE('01-09-2024', 'DD-MM-YYYY'), TO_DATE('30-12-2024', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH03', 'HP03', 'GV02', '1', '2024', TO_DATE('01-09-2024', 'DD-MM-YYYY'), TO_DATE('30-12-2024', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH04', 'HP04', 'GV02', '2', '2024', TO_DATE('01-01-2025', 'DD-MM-YYYY'), TO_DATE('30-04-2025', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH05', 'HP05', 'GV03', '2', '2024', TO_DATE('01-01-2025', 'DD-MM-YYYY'), TO_DATE('30-04-2025', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH06', 'HP06', 'GV03', '2', '2024', TO_DATE('01-01-2025', 'DD-MM-YYYY'), TO_DATE('30-04-2025', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH07', 'HP07', 'GV03', '3', '2024', TO_DATE('01-05-2025', 'DD-MM-YYYY'), TO_DATE('30-08-2025', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH08', 'HP08', 'GV04', '3', '2024', TO_DATE('01-05-2025', 'DD-MM-YYYY'), TO_DATE('30-08-2025', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH09', 'HP09', 'GV04', '3', '2024', TO_DATE('01-05-2025', 'DD-MM-YYYY'), TO_DATE('30-08-2025', 'DD-MM-YYYY'));
INSERT INTO pdb_admin.QLDH_MONHOC (MAMH, MAHP, MAGV, HK, NAM, NGAYBATDAU, NGAYKETTHUC) VALUES ('MH10', 'HP10', 'GV04', '3', '2024', TO_DATE('01-05-2025', 'DD-MM-YYYY'), TO_DATE('30-08-2025', 'DD-MM-YYYY'));

-- Thêm dữ liệu mẫu cho HOCPHAN
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP01', 'Nhap mon lap trinh', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP02', 'Ky thuat lap trinh', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP03', 'DSA', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP04', 'Mang may tinh', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP05', 'OOP', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP06', 'He thong may tinh', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP07', 'He dieu hanh', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP08', 'Nhap mon AI', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP09', 'Nhap mon phan mem', 4, 30, 15, 'KH01');
INSERT INTO pdb_admin.QLDH_HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('HP10', 'Test mon hoc', 4, 30, 15, 'KH01');

-- Thêm dữ liệu mẫu cho NHANVIEN
INSERT INTO pdb_admin.QLDH_NHANVIEN (MANV, HOTEN, PHAI, NGSINH, DCHI, LUONG, PHUCAP, DT, VAITRO, MADV) VALUES ('GV01', 'Nguyen Van A', 'Nam', TO_DATE('01-01-1975', 'DD-MM-YYYY'), 'HCM', 3000, 200, '123456789', 'GV', 'KH01');
INSERT INTO pdb_admin.QLDH_NHANVIEN (MANV, HOTEN, PHAI, NGSINH, DCHI, LUONG, PHUCAP, DT, VAITRO, MADV) VALUES ('GV02', 'Tran Thi B', 'Nu', TO_DATE('01-01-1975', 'DD-MM-YYYY'), 'HCM', 3000, 200, '123456789', 'GV', 'KH01');
INSERT INTO pdb_admin.QLDH_NHANVIEN (MANV, HOTEN, PHAI, NGSINH, DCHI, LUONG, PHUCAP, DT, VAITRO, MADV) VALUES ('GV03', 'Le Minh C', 'Nam', TO_DATE('01-01-1975', 'DD-MM-YYYY'), 'HCM', 3000, 200, '123456789', 'GV', 'KH01');
INSERT INTO pdb_admin.QLDH_NHANVIEN (MANV, HOTEN, PHAI, NGSINH, DCHI, LUONG, PHUCAP, DT, VAITRO, MADV) VALUES ('GV04', 'Hoang Ngoc D', 'Nu', TO_DATE('01-01-1975', 'DD-MM-YYYY'), 'HCM', 3000, 200, '123456789', 'GV', 'KH01');
INSERT INTO pdb_admin.QLDH_NHANVIEN (MANV, HOTEN, PHAI, NGSINH, DCHI, LUONG, PHUCAP, DT, VAITRO, MADV) VALUES ('GV05', 'Ly Cat E', 'Nu', TO_DATE('01-01-1975', 'DD-MM-YYYY'), 'HCM', 3000, 200, '123456789', 'GV', 'KH02');
INSERT INTO pdb_admin.QLDH_NHANVIEN (MANV, HOTEN, PHAI, NGSINH, DCHI, LUONG, PHUCAP, DT, VAITRO, MADV) VALUES ('GV06', 'Mac Linh F', 'Nu', TO_DATE('01-01-1975', 'DD-MM-YYYY'), 'HCM', 3000, 200, '123456789', 'GV', 'KH03');

-- Đang phải grant quyền trực tiếp để thao tác (thay TEST_NVPDT bằng user phòng đào tạo)
-- GRANT SELECT, INSERT, UPDATE, DELETE ON pdb_admin.QLDH_NHANVIEN TO TEST_NVPDT;
-- GRANT SELECT, INSERT, UPDATE, DELETE ON pdb_admin.QLDH_MONHOC TO TEST_NVPDT;
-- GRANT SELECT, INSERT, UPDATE, DELETE ON pdb_admin.QLDH_HOCPHAN TO TEST_NVPDT;

